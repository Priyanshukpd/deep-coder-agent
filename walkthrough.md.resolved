# God Mode Agent ‚Äî Full Architecture Walkthrough

## Summary

Built a **production-ready agentic coding assistant** with a 12-step execution pipeline, multi-stack support for any language/framework, and a hardened governance layer. The agent can plan, write, compile, run, self-correct, and verify code autonomously ‚Äî from Python scripts to full-stack Docker applications.

**Version:** v9.0 (Autonomous)

## Verification Results

| Check | Result |
|-------|--------|
| Governance self-test | **14/14 pass** ‚úÖ |
| Module imports | **37/37 pass** ‚úÖ |
| Unit tests | **27/27 pass** ‚úÖ |
| Dependency graph | 28 nodes, 168 edges auto-detected |
| Supply chain detection | Correctly flags `reqeusts` as typosquat of `requests` |
| Express lane | Correctly gates docs-only vs code changes |
| Interactive Browser | **DuckDuckGo search / Title Verified** ‚úÖ |
| Auto-Healing | **Self-correction loop / Verify-Fix-Verify** ‚úÖ |
| **Security Advisor** | **LLM Reasoning (SAFE/SUSPICIOUS) Verification** ‚úÖ |
| **Shell Power** | **Direct `mv/rm` execution verified** ‚úÖ |

---

## Core Execution Engine

The heart of the agent ‚Äî the 12-step agentic pipeline that handles any coding task.

### Key Modules

| Module | Path | Purpose |
|--------|------|---------|
| **TaskExecutor** | [task_executor.py](file:///Users/munishm/Documents/god-mode-agent/agent/core/task_executor.py) | 12-step pipeline: plan ‚Üí code ‚Üí lint ‚Üí compile ‚Üí run ‚Üí fix ‚Üí verify ‚Üí commit |
| **Chat** | [chat.py](file:///Users/munishm/Documents/god-mode-agent/agent/core/chat.py) | Conversational interface with task routing |
| **StackProfiles** | [stack_profiles.py](file:///Users/munishm/Documents/god-mode-agent/agent/core/stack_profiles.py) | 8 stack profiles (Python, Java, Node, Go, Rust, Dart, Docker, Generic) |
| **LLM Provider** | [llm_provider.py](file:///Users/munishm/Documents/god-mode-agent/agent/llm_provider.py) | Together AI integration |
| **Web UI** | [web_ui.py](file:///Users/munishm/Documents/god-mode-agent/agent/web_ui.py) | Streamlit chat interface |
| **CLI** | [cli.py](file:///Users/munishm/Documents/god-mode-agent/agent/cli.py) | Command-line interface + self-test runner |

### Execution Pipeline (12 Steps)

```
Step 0b ‚Üí Detect Stack (task keywords + repo analysis)
Step 1  ‚Üí Generate Plan (LLM ‚Üí install/compile/lint/run/test commands)
Step 1b ‚Üí Runtime Pre-Check (shutil.which ‚Üí java? node? docker?)
Step 2  ‚Üí Freeze Plan Envelope (SHA256 scope lock)
Step 3  ‚Üí Supply Chain Check (dependency safety scan)
Step 4  ‚Üí Task Isolation (git checkout -b agent/task-id)
Step 5  ‚Üí Generate Code (LLM per file ‚Üí secrets scan ‚Üí write)
Step 6  ‚Üí Lint / Syntax (LSP for Python, subprocess for others)
Step 7  ‚Üí Install Deps + Compile
Step 8  ‚Üí Run Code (smart timeouts, server detection, multi-step)
Step 9  ‚Üí Self-Correction (universal error detection ‚Üí LLM fix ‚Üí recompile ‚Üí re-run, max 3)
Step 10 ‚Üí Verification Pipeline (syntax ‚Üí unit ‚Üí integration)
Step 11 ‚Üí Plan Enforcement (no unplanned files)
Step 12 ‚Üí Auto-Git Commit ([god-mode-agent] summary)
```

### Smart Command Execution

| Feature | How it works |
|---------|-------------|
| **Smart timeouts** | Docker=60m, Java/Rust=45m, default=30m (adaptive) |
| **Adaptive Kill Switch** | `heartbeat()` extends deadline during activity, `extend()` adds time for slow builds |
| **Real-Time Logs** | Output streamed line-by-line via `ProcessManager` (no more silent builds) |
| **Parallel Processes** | Backend + Frontend running simultaneously (background Popen) |
| **DB Lifecycle** | Auto-detects migrations/seeds ‚Üí runs before main app |
| **.env Handling** | Generates safe `.env` from `.env.example` if missing |
| **Server detection** | `flask run`, `npm start`, etc. ‚Üí background Popen |
| **Health check** | Auto-detect port + ping `localhost:PORT` with retries |
| **Multi-step commands** | `run_commands[]` array ‚Üí sequential execution |
| **Universal error parsing** | Known patterns (Python/Java/Node/Rust/Dart) + catch-all `file.ext:lineN` for any language |
| **Runtime pre-check** | Verify `java`, `node`, `docker`, etc. exist before executing |
| **Auto-git commit** | On success ‚Üí `git add` + `commit "[god-mode-agent] ..."` |
| **Background cleanup** | All Popen processes terminated in `finally` block |

### Phase 11: Cognitive Enhancements ("The Brain")
- **Smart Stack Detection**: LLM heuristic fallback if `RepoDiscovery` fails.
- **Persistent Memory**: `.agent/architecture.md` logs key decisions.
- **Semantic Code Search**: Context-aware file selection (`_select_relevant_files`).

### Phase 12: Tooling Depth ("The Hands")
- **Docker Inspector**: `logs`, `inspect`, `exec` for container debugging.
- **Database Inspector**: `inspect_tables`, `check_migrations`.
- **Browser Tester**: Headless `playwright` verification of web UIs.

### Phase 13: Interactive Troubleshooting ("The Mouth")
- **Guided Debugging**: `_ask_for_help` prompt if self-correction fails 3 times.

### Phase 14: External Knowledge ("The Library Card") üìö
- **Doc Crawler**: `search_docs` + `read_page` to fetch API docs on-the-fly.
- **Integration**: `_gather_diagnostics` searches docs on `ImportError`/`AttributeError`.

### Phase 23: LLM-Controlled Security Advisor ("The Analyst") üõ°Ô∏è
- **Dynamic Reasoning**: Replaced hardcoded whitelists with an LLM-powered second opinion layer.
- **False Positive Handling**: Correctly identifies and allows standard libraries (e.g., `os`) while blocking real risks.

### Phase 24: Repository Beautification (Project 'Wings') üìÇ‚ú®
- **Autonomous Task**: Full reorganization of a messy repository into `src`, `data`, `docs`, `models`, and `tests`.
- **Validation**: Verified end-to-end success with zero manual intervention.

### Phase 25: Shell Command Empowerment ("The Antigravity Way") üêö‚ö°
- **Direct Shell Support**: Enabled the Agent to use `mv`, `rm`, `cp`, and `mkdir` directly in `run_commands` instead of writing scripts.
- **Efficiency**: Verified autonomous cleanup of files using direct shell execution.

- **Phase 26: Reactive Feedback Loop**: Enabled mid-execution natural language "course corrections" and re-planning.
- **Phase 27: React Evolution**: Decoupled UI with FastAPI backend and Vite+React frontend for a scalable, premium experience.
- **Phase 28: Smarter Self-Correction**: Implemented stateful `fix_history` in the Agent's repair loop, preventing it from repeating the same failed code fixes.
- **Phase 29: Chain-of-Thought Autonomy**: Empowered the LLM to output a `üß† Analysis` block prior to all coding and fixing operations, significantly improving project-awareness and preventing hallucinated fixes.
- **Phase 30: Context-Aware Intent Routing**: Injected real-time repository discovery logs (stack type, file counts) directly into the Intent Classifier LLM array, and enforced strict abort guardrails against vague single-line inputs during `--yes` automation runs.
- **Phase 31: End-to-End Planning Intelligence**: Upgraded the core JSON `PLANNING_PROMPT` to mandate full architectural inspection before creating execution plans. The prompt now injects a flat list of the top 200 repository files into context *before* the planner acts, allowing the LLM to autonomously detect files like `ui.tsx` or `login.py` instead of hallucinating new creations.
- **Phase 32: Intelligent Early Stopping**: Added an `AbortFixLoopException` driven by an `@ABORT: <reason>` semantic token inside the `<analysis>` block, granting the LLM the capability to permanently break out of the 7-attempt fix retry loop if it determines an error is fundamentally unfixable (e.g., missing dependencies or impossible constraints).
- **Phase 33: React UI Real-Time Execution Streaming**: Patched the FastAPI backend's `sys.stdout` directly to queue strings into an Server-Sent Events (SSE) `/api/stream/` endpoint. Updated the React Frontend UI with `EventSource` to receive these events, thereby streaming exact terminal outputs into a sleek scrolling terminal box directly inside the web UI matching GitHub Copilot/Windsurf functionality!

### Phase 1-13 Polish (Robustness) üíé
- **Active Debugging**: Auto-run inspectors/crawlers on error -> feed logs to LLM.
- **Process Resilience**: `wait_for_port` detects early crashes immediately.
---

## Governance Layer (37 Modules)

### Architecture Map

```mermaid
graph TD
    subgraph P1["Phase 1 - Core Control"]
        state["state.py"] --> controller["controller.py"]
        risk["risk_budget.py"] --> controller
        cmd["command_safety.py"] --> controller
        rbac["rbac.py"] --> controller
        intent["intent.py"] --> controller
        pre["preconditions.py"] --> controller
        gov["governance_self_test.py"]
        config["config.py"] --> llm["llm_provider.py"]
        llm --> intent
    end

    subgraph P2["Phase 2 - Execution Hardening"]
        iso["task_isolation.py"]
        env["plan_envelope.py"]
        kill["kill_switch.py"]
        net["network_policy.py"]
        merge["merge_guard.py"]
        roll["rollback.py"]
        ci["ci_gate.py"]
    end

    subgraph P3["Phase 3 - Cognitive Hardening"]
        tdd["tdd_gate.py"]
        anti["anti_mocking.py"]
        lsp["lsp_loop.py"]
        replay["replay_log.py"]
        nondet["nondeterminism_budget.py"]
        express["express_lane.py"]
        supply["supply_chain.py"]
        ctxgraph["context_graph.py"]
    end

    subgraph P4["Phase 4 - Execution"]
        sandbox["sandbox.py"] --> cmd
        sandbox --> net
        diff["diff_editor.py"]
        secrets["secrets_policy.py"]
        shell["shell_session.py"]
    end

    subgraph P5["Phase 5 - Planning"]
        plan["plan_enforcer.py"]
        impact["impact_analysis.py"] --> ctxgraph
        repo["repo_discovery.py"]
    end

    subgraph P6["Phase 6 - Verification"]
        verify["verification_pipeline.py"]
        testgen["test_generator.py"]
        feedback["feedback_loop.py"] --> state
    end

    subgraph P7["Phase 7 - Deep Intelligence"]
        search["code_search.py"]
        docs["docs_rag.py"]
    end
```

### Phase 1: Core Control (10 modules)
| Module | Purpose |
|--------|---------|
| [state.py](file:///Users/munishm/Documents/god-mode-agent/agent/state.py) | 12-state machine with granular FAILED_BY_* terminals |
| [controller.py](file:///Users/munishm/Documents/god-mode-agent/agent/controller.py) | Main orchestrator with LLM integration |
| [config.py](file:///Users/munishm/Documents/god-mode-agent/agent/config.py) | Centralized config with sampling_policy_hash |
| [llm_provider.py](file:///Users/munishm/Documents/god-mode-agent/agent/llm_provider.py) | Together AI provider with tool calling |
| [intent.py](file:///Users/munishm/Documents/god-mode-agent/agent/intent.py) | LLM-powered intent classifier with heuristic fallback |
| [risk_budget.py](file:///Users/munishm/Documents/god-mode-agent/agent/risk_budget.py) | Risk budget with 3-strike exhaustion |
| [command_safety.py](file:///Users/munishm/Documents/god-mode-agent/agent/command_safety.py) | 3-tier command classification |
| [rbac.py](file:///Users/munishm/Documents/god-mode-agent/agent/rbac.py) | Role-based access control |
| [preconditions.py](file:///Users/munishm/Documents/god-mode-agent/agent/preconditions.py) | Git consistency + file checksums |
| [governance_self_test.py](file:///Users/munishm/Documents/god-mode-agent/agent/governance_self_test.py) | 14/14 governance validations |

### Phase 2: Execution Hardening (7 modules)
| Module | Purpose |
|--------|---------|
| [task_isolation.py](file:///Users/munishm/Documents/god-mode-agent/agent/task_isolation.py) | Atomic branching + clean tree assertion |
| [plan_envelope.py](file:///Users/munishm/Documents/god-mode-agent/agent/plan_envelope.py) | Input snapshot hashing + scope enforcement |
| [kill_switch.py](file:///Users/munishm/Documents/god-mode-agent/agent/kill_switch.py) | Adaptive timeouts (stack-aware) + emergency halt |
| [network_policy.py](file:///Users/munishm/Documents/god-mode-agent/agent/network_policy.py) | Block network commands during IMPLEMENTING |
| [merge_guard.py](file:///Users/munishm/Documents/god-mode-agent/agent/merge_guard.py) | 4 CI binding guards ¬ß2.E |
| [rollback.py](file:///Users/munishm/Documents/god-mode-agent/agent/rollback.py) | 3-domain atomic git reset |
| [ci_gate.py](file:///Users/munishm/Documents/god-mode-agent/agent/ci_gate.py) | Abstract + mock CI integration |

### Phase 3: Cognitive Hardening (8 modules)
| Module | Purpose |
|--------|---------|
| [tdd_gate.py](file:///Users/munishm/Documents/god-mode-agent/agent/tdd_gate.py) | Red/Green integrity with content hashing |
| [anti_mocking.py](file:///Users/munishm/Documents/god-mode-agent/agent/anti_mocking.py) | Detects tautological tests |
| [lsp_loop.py](file:///Users/munishm/Documents/god-mode-agent/agent/lsp_loop.py) | 3-retry cap, logic fail = STOP |
| [replay_log.py](file:///Users/munishm/Documents/god-mode-agent/agent/replay_log.py) | Forensic tool hash + session verification |
| [nondeterminism_budget.py](file:///Users/munishm/Documents/god-mode-agent/agent/nondeterminism_budget.py) | temp=0 enforcement + prompt mutation detection |
| [express_lane.py](file:///Users/munishm/Documents/god-mode-agent/agent/express_lane.py) | Docs-only fast path, blocks shebang/chmod |
| [supply_chain.py](file:///Users/munishm/Documents/god-mode-agent/agent/supply_chain.py) | Levenshtein-based typosquat detection |
| [context_graph.py](file:///Users/munishm/Documents/god-mode-agent/agent/context_graph.py) | AST import graph + transitive closure |

### Phase 4: Execution & Diffs (4 modules)
| Module | Purpose |
|--------|---------|
| [sandbox.py](file:///Users/munishm/Documents/god-mode-agent/agent/sandbox.py) | Safety-gated command runner |
| [diff_editor.py](file:///Users/munishm/Documents/god-mode-agent/agent/diff_editor.py) | Atomic patch sets with drift detection |
| [secrets_policy.py](file:///Users/munishm/Documents/god-mode-agent/agent/secrets_policy.py) | Regex secret detection + redaction |
| [shell_session.py](file:///Users/munishm/Documents/god-mode-agent/agent/shell_session.py) | Persistent shell with session manager |

### Phase 5: Planning & Discipline (3 modules)
| Module | Purpose |
|--------|---------|
| [plan_enforcer.py](file:///Users/munishm/Documents/god-mode-agent/agent/plan_enforcer.py) | task.md/plan.md existence enforcement |
| [impact_analysis.py](file:///Users/munishm/Documents/god-mode-agent/agent/impact_analysis.py) | LOW/MEDIUM/HIGH/CRITICAL risk classification |
| [repo_discovery.py](file:///Users/munishm/Documents/god-mode-agent/agent/repo_discovery.py) | Stack detection + RepoMap builder |

### Phase 6: Verification & Feedback (3 modules)
| Module | Purpose |
|--------|---------|
| [verification_pipeline.py](file:///Users/munishm/Documents/god-mode-agent/agent/verification_pipeline.py) | 5-tier gated pipeline |
| [test_generator.py](file:///Users/munishm/Documents/god-mode-agent/agent/test_generator.py) | TDD scaffold generation |
| [feedback_loop.py](file:///Users/munishm/Documents/god-mode-agent/agent/feedback_loop.py) | 24h timeout + state routing |

### Phase 7: Deep Intelligence (2 modules)
| Module | Purpose |
|--------|---------|
| [code_search.py](file:///Users/munishm/Documents/god-mode-agent/agent/code_search.py) | ripgrep + ChromaDB semantic search |
| [docs_rag.py](file:///Users/munishm/Documents/god-mode-agent/agent/docs_rag.py) | External docs RAG with chunking |

---

## Security Layers

| Layer | Module | Protection |
|-------|--------|------------|
| Kill Switch | `kill_switch.py` | Emergency halt at any pipeline step |
| Command Safety | `command_safety.py` | SAFE / NETWORK / BLOCK tier classification |
| RBAC | `rbac.py` | DEVELOPER / ARCHITECT / ADMIN permissions |
| Secrets Policy | `secrets_policy.py` | Regex detection + auto-redaction before write |
| Supply Chain | `supply_chain.py` | Typosquatting detection via Levenshtein distance |
| Plan Envelope | `plan_envelope.py` | Immutable scope ‚Äî no unplanned file writes |
| Task Isolation | `task_isolation.py` | Git branch per task ‚Äî rollback on failure |
| Runtime Pre-Check | `task_executor.py` | Verify tools exist before executing commands |
