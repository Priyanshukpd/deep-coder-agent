# God Mode Agent â€” Full Architecture Walkthrough

## Summary

Built a **production-ready agentic coding assistant** with a 12-step execution pipeline, multi-stack support for any language/framework, and a hardened governance layer. The agent can plan, write, compile, run, self-correct, and verify code autonomously â€” from Python scripts to full-stack Docker applications.

**Version:** v8.0 (Multi-Stack)

## Verification Results

| Check | Result |
|-------|--------|
| Governance self-test | **14/14 pass** âœ… |
| Module imports | **37/37 pass** âœ… |
| Unit tests | **27/27 pass** âœ… |
| Dependency graph | 28 nodes, 168 edges auto-detected |
| Supply chain detection | Correctly flags `reqeusts` as typosquat of `requests` |
| Express lane | Correctly gates docs-only vs code changes |

---

## Core Execution Engine

The heart of the agent â€” the 12-step agentic pipeline that handles any coding task.

### Key Modules

| Module | Path | Purpose |
|--------|------|---------|
| **TaskExecutor** | [task_executor.py](file:///Users/munishm/Documents/god-mode-agent/agent/core/task_executor.py) | 12-step pipeline: plan â†’ code â†’ lint â†’ compile â†’ run â†’ fix â†’ verify â†’ commit |
| **Chat** | [chat.py](file:///Users/munishm/Documents/god-mode-agent/agent/core/chat.py) | Conversational interface with task routing |
| **StackProfiles** | [stack_profiles.py](file:///Users/munishm/Documents/god-mode-agent/agent/core/stack_profiles.py) | 8 stack profiles (Python, Java, Node, Go, Rust, Dart, Docker, Generic) |
| **LLM Provider** | [llm_provider.py](file:///Users/munishm/Documents/god-mode-agent/agent/llm_provider.py) | Together AI integration |
| **Web UI** | [web_ui.py](file:///Users/munishm/Documents/god-mode-agent/agent/web_ui.py) | Streamlit chat interface |
| **CLI** | [cli.py](file:///Users/munishm/Documents/god-mode-agent/agent/cli.py) | Command-line interface + self-test runner |

### Execution Pipeline (12 Steps)

```
Step 0b â†’ Detect Stack (task keywords + repo analysis)
Step 1  â†’ Generate Plan (LLM â†’ install/compile/lint/run/test commands)
Step 1b â†’ Runtime Pre-Check (shutil.which â†’ java? node? docker?)
Step 2  â†’ Freeze Plan Envelope (SHA256 scope lock)
Step 3  â†’ Supply Chain Check (dependency safety scan)
Step 4  â†’ Task Isolation (git checkout -b agent/task-id)
Step 5  â†’ Generate Code (LLM per file â†’ secrets scan â†’ write)
Step 6  â†’ Lint / Syntax (LSP for Python, subprocess for others)
Step 7  â†’ Install Deps + Compile
Step 8  â†’ Run Code (smart timeouts, server detection, multi-step)
Step 9  â†’ Self-Correction (universal error detection â†’ LLM fix â†’ recompile â†’ re-run, max 3)
Step 10 â†’ Verification Pipeline (syntax â†’ unit â†’ integration)
Step 11 â†’ Plan Enforcement (no unplanned files)
Step 12 â†’ Auto-Git Commit ([god-mode-agent] summary)
```

### Smart Command Execution

| Feature | How it works |
|---------|-------------|
| **Smart timeouts** | Docker=60m, Java/Rust=45m, default=30m (adaptive) |
| **Adaptive Kill Switch** | `heartbeat()` extends deadline during activity, `extend()` adds time for slow builds |
| **Real-Time Logs** | Output streamed line-by-line via `ProcessManager` (no more silent builds) |
| **Parallel Processes** | Backend + Frontend running simultaneously (background Popen) |
| **DB Lifecycle** | Auto-detects migrations/seeds â†’ runs before main app |
| **.env Handling** | Generates safe `.env` from `.env.example` if missing |
| **Server detection** | `flask run`, `npm start`, etc. â†’ background Popen |
| **Health check** | Auto-detect port + ping `localhost:PORT` with retries |
| **Multi-step commands** | `run_commands[]` array â†’ sequential execution |
| **Universal error parsing** | Known patterns (Python/Java/Node/Rust/Dart) + catch-all `file.ext:lineN` for any language |
| **Runtime pre-check** | Verify `java`, `node`, `docker`, etc. exist before executing |
| **Auto-git commit** | On success â†’ `git add` + `commit "[god-mode-agent] ..."` |
| **Background cleanup** | All Popen processes terminated in `finally` block |

### Phase 11: Cognitive Enhancements ("The Brain")
- **Smart Stack Detection**: LLM heuristic fallback if `RepoDiscovery` fails.
- **Persistent Memory**: `.agent/architecture.md` logs key decisions.
- **Semantic Code Search**: Context-aware file selection (`_select_relevant_files`).

### Phase 12: Tooling Depth ("The Hands")
- **Docker Inspector**: `logs`, `inspect`, `exec` for container debugging.
- **Database Inspector**: `inspect_tables`, `check_migrations`.
- **Browser Tester**: Headless `playwright` verification of web UIs.

### Phase 13: Interactive Troubleshooting ("The Mouth")
- **Guided Debugging**: `_ask_for_help` prompt if self-correction fails 3 times.

### Phase 14: External Knowledge ("The Library Card") ðŸ“š
- **Doc Crawler**: `search_docs` + `read_page` to fetch API docs on-the-fly.
- **Auto-Research**: Triggers on `ImportError`/`AttributeError`.

### Phase 1-13 Polish (Robustness) ðŸ’Ž
- **Active Debugging**: Auto-run inspectors/crawlers on error -> feed logs to LLM.
- **Process Resilience**: `wait_for_port` detects early crashes immediately.
---

## Governance Layer (37 Modules)

### Architecture Map

```mermaid
graph TD
    subgraph P1["Phase 1 - Core Control"]
        state["state.py"] --> controller["controller.py"]
        risk["risk_budget.py"] --> controller
        cmd["command_safety.py"] --> controller
        rbac["rbac.py"] --> controller
        intent["intent.py"] --> controller
        pre["preconditions.py"] --> controller
        gov["governance_self_test.py"]
        config["config.py"] --> llm["llm_provider.py"]
        llm --> intent
    end

    subgraph P2["Phase 2 - Execution Hardening"]
        iso["task_isolation.py"]
        env["plan_envelope.py"]
        kill["kill_switch.py"]
        net["network_policy.py"]
        merge["merge_guard.py"]
        roll["rollback.py"]
        ci["ci_gate.py"]
    end

    subgraph P3["Phase 3 - Cognitive Hardening"]
        tdd["tdd_gate.py"]
        anti["anti_mocking.py"]
        lsp["lsp_loop.py"]
        replay["replay_log.py"]
        nondet["nondeterminism_budget.py"]
        express["express_lane.py"]
        supply["supply_chain.py"]
        ctxgraph["context_graph.py"]
    end

    subgraph P4["Phase 4 - Execution"]
        sandbox["sandbox.py"] --> cmd
        sandbox --> net
        diff["diff_editor.py"]
        secrets["secrets_policy.py"]
        shell["shell_session.py"]
    end

    subgraph P5["Phase 5 - Planning"]
        plan["plan_enforcer.py"]
        impact["impact_analysis.py"] --> ctxgraph
        repo["repo_discovery.py"]
    end

    subgraph P6["Phase 6 - Verification"]
        verify["verification_pipeline.py"]
        testgen["test_generator.py"]
        feedback["feedback_loop.py"] --> state
    end

    subgraph P7["Phase 7 - Deep Intelligence"]
        search["code_search.py"]
        docs["docs_rag.py"]
    end
```

### Phase 1: Core Control (10 modules)
| Module | Purpose |
|--------|---------|
| [state.py](file:///Users/munishm/Documents/god-mode-agent/agent/state.py) | 12-state machine with granular FAILED_BY_* terminals |
| [controller.py](file:///Users/munishm/Documents/god-mode-agent/agent/controller.py) | Main orchestrator with LLM integration |
| [config.py](file:///Users/munishm/Documents/god-mode-agent/agent/config.py) | Centralized config with sampling_policy_hash |
| [llm_provider.py](file:///Users/munishm/Documents/god-mode-agent/agent/llm_provider.py) | Together AI provider with tool calling |
| [intent.py](file:///Users/munishm/Documents/god-mode-agent/agent/intent.py) | LLM-powered intent classifier with heuristic fallback |
| [risk_budget.py](file:///Users/munishm/Documents/god-mode-agent/agent/risk_budget.py) | Risk budget with 3-strike exhaustion |
| [command_safety.py](file:///Users/munishm/Documents/god-mode-agent/agent/command_safety.py) | 3-tier command classification |
| [rbac.py](file:///Users/munishm/Documents/god-mode-agent/agent/rbac.py) | Role-based access control |
| [preconditions.py](file:///Users/munishm/Documents/god-mode-agent/agent/preconditions.py) | Git consistency + file checksums |
| [governance_self_test.py](file:///Users/munishm/Documents/god-mode-agent/agent/governance_self_test.py) | 14/14 governance validations |

### Phase 2: Execution Hardening (7 modules)
| Module | Purpose |
|--------|---------|
| [task_isolation.py](file:///Users/munishm/Documents/god-mode-agent/agent/task_isolation.py) | Atomic branching + clean tree assertion |
| [plan_envelope.py](file:///Users/munishm/Documents/god-mode-agent/agent/plan_envelope.py) | Input snapshot hashing + scope enforcement |
| [kill_switch.py](file:///Users/munishm/Documents/god-mode-agent/agent/kill_switch.py) | Adaptive timeouts (stack-aware) + emergency halt |
| [network_policy.py](file:///Users/munishm/Documents/god-mode-agent/agent/network_policy.py) | Block network commands during IMPLEMENTING |
| [merge_guard.py](file:///Users/munishm/Documents/god-mode-agent/agent/merge_guard.py) | 4 CI binding guards Â§2.E |
| [rollback.py](file:///Users/munishm/Documents/god-mode-agent/agent/rollback.py) | 3-domain atomic git reset |
| [ci_gate.py](file:///Users/munishm/Documents/god-mode-agent/agent/ci_gate.py) | Abstract + mock CI integration |

### Phase 3: Cognitive Hardening (8 modules)
| Module | Purpose |
|--------|---------|
| [tdd_gate.py](file:///Users/munishm/Documents/god-mode-agent/agent/tdd_gate.py) | Red/Green integrity with content hashing |
| [anti_mocking.py](file:///Users/munishm/Documents/god-mode-agent/agent/anti_mocking.py) | Detects tautological tests |
| [lsp_loop.py](file:///Users/munishm/Documents/god-mode-agent/agent/lsp_loop.py) | 3-retry cap, logic fail = STOP |
| [replay_log.py](file:///Users/munishm/Documents/god-mode-agent/agent/replay_log.py) | Forensic tool hash + session verification |
| [nondeterminism_budget.py](file:///Users/munishm/Documents/god-mode-agent/agent/nondeterminism_budget.py) | temp=0 enforcement + prompt mutation detection |
| [express_lane.py](file:///Users/munishm/Documents/god-mode-agent/agent/express_lane.py) | Docs-only fast path, blocks shebang/chmod |
| [supply_chain.py](file:///Users/munishm/Documents/god-mode-agent/agent/supply_chain.py) | Levenshtein-based typosquat detection |
| [context_graph.py](file:///Users/munishm/Documents/god-mode-agent/agent/context_graph.py) | AST import graph + transitive closure |

### Phase 4: Execution & Diffs (4 modules)
| Module | Purpose |
|--------|---------|
| [sandbox.py](file:///Users/munishm/Documents/god-mode-agent/agent/sandbox.py) | Safety-gated command runner |
| [diff_editor.py](file:///Users/munishm/Documents/god-mode-agent/agent/diff_editor.py) | Atomic patch sets with drift detection |
| [secrets_policy.py](file:///Users/munishm/Documents/god-mode-agent/agent/secrets_policy.py) | Regex secret detection + redaction |
| [shell_session.py](file:///Users/munishm/Documents/god-mode-agent/agent/shell_session.py) | Persistent shell with session manager |

### Phase 5: Planning & Discipline (3 modules)
| Module | Purpose |
|--------|---------|
| [plan_enforcer.py](file:///Users/munishm/Documents/god-mode-agent/agent/plan_enforcer.py) | task.md/plan.md existence enforcement |
| [impact_analysis.py](file:///Users/munishm/Documents/god-mode-agent/agent/impact_analysis.py) | LOW/MEDIUM/HIGH/CRITICAL risk classification |
| [repo_discovery.py](file:///Users/munishm/Documents/god-mode-agent/agent/repo_discovery.py) | Stack detection + RepoMap builder |

### Phase 6: Verification & Feedback (3 modules)
| Module | Purpose |
|--------|---------|
| [verification_pipeline.py](file:///Users/munishm/Documents/god-mode-agent/agent/verification_pipeline.py) | 5-tier gated pipeline |
| [test_generator.py](file:///Users/munishm/Documents/god-mode-agent/agent/test_generator.py) | TDD scaffold generation |
| [feedback_loop.py](file:///Users/munishm/Documents/god-mode-agent/agent/feedback_loop.py) | 24h timeout + state routing |

### Phase 7: Deep Intelligence (2 modules)
| Module | Purpose |
|--------|---------|
| [code_search.py](file:///Users/munishm/Documents/god-mode-agent/agent/code_search.py) | ripgrep + ChromaDB semantic search |
| [docs_rag.py](file:///Users/munishm/Documents/god-mode-agent/agent/docs_rag.py) | External docs RAG with chunking |

---

## Security Layers

| Layer | Module | Protection |
|-------|--------|------------|
| Kill Switch | `kill_switch.py` | Emergency halt at any pipeline step |
| Command Safety | `command_safety.py` | SAFE / NETWORK / BLOCK tier classification |
| RBAC | `rbac.py` | DEVELOPER / ARCHITECT / ADMIN permissions |
| Secrets Policy | `secrets_policy.py` | Regex detection + auto-redaction before write |
| Supply Chain | `supply_chain.py` | Typosquatting detection via Levenshtein distance |
| Plan Envelope | `plan_envelope.py` | Immutable scope â€” no unplanned file writes |
| Task Isolation | `task_isolation.py` | Git branch per task â€” rollback on failure |
| Runtime Pre-Check | `task_executor.py` | Verify tools exist before executing commands |
